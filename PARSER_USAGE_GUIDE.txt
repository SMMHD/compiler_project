
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² cache_parser.py                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù¾Ø§ÛŒÙ‡
2. ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
3. Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ AST
4. Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ
5. Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
6. Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§


1ï¸âƒ£ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù¾Ø§ÛŒÙ‡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Import
from cache_parser import parse_instruction, parse_file

# Ù¾Ø§Ø±Ø³ ÛŒÚ© Ø¯Ø³ØªÙˆØ±
ast = parse_instruction("CLFLUSH [EAX]")
print(ast)  # Instruction(CLFLUSH, Memory([EAX]))

# Ù¾Ø§Ø±Ø³ ÛŒÚ© ÙØ§ÛŒÙ„
results, errors = parse_file("example1_simple.asm")


2ï¸âƒ£ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¸ parse_instruction(code, debug=False)
  Ù¾Ø§Ø±Ø³ ÛŒÚ© Ø¯Ø³ØªÙˆØ± assembly

  Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§:
    - code: str - Ø±Ø´ØªÙ‡ Ø¯Ø³ØªÙˆØ±
    - debug: bool - Ù†Ù…Ø§ÛŒØ´ Ù…Ø±Ø§Ø­Ù„ Ù¾Ø§Ø±Ø³ÛŒÙ†Ú¯

  Ø®Ø±ÙˆØ¬ÛŒ:
    - Instruction object ÛŒØ§ None

  Ù…Ø«Ø§Ù„:
    ast = parse_instruction("CLFLUSH [EBX+16]", debug=True)


â–¸ parse_file(filename, debug=False)
  Ù¾Ø§Ø±Ø³ ÛŒÚ© ÙØ§ÛŒÙ„ Ú©Ø§Ù…Ù„

  Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§:
    - filename: str - Ù†Ø§Ù… ÙØ§ÛŒÙ„
    - debug: bool - Ø­Ø§Ù„Øª Ø¯ÛŒØ¨Ø§Ú¯

  Ø®Ø±ÙˆØ¬ÛŒ:
    - (results, errors) tuple
    - results: [(line_num, code, ast), ...]
    - errors: [(line_num, code, error), ...]

  Ù…Ø«Ø§Ù„:
    results, errors = parse_file("test.asm")
    for line_num, code, ast in results:
        print(f"Line {line_num}: {ast}")


â–¸ analyze_instruction(ast)
  ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø³ØªÙˆØ±

  Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§:
    - ast: Instruction object

  Ø®Ø±ÙˆØ¬ÛŒ:
    - dict Ø­Ø§ÙˆÛŒ ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„

  Ù…Ø«Ø§Ù„:
    analysis = analyze_instruction(ast)
    print(analysis['category'])  # 'flush'


â–¸ build_parser(debug=False)
  Ø³Ø§Ø®Øª parser object

  Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡:
    lexer = build_lexer()
    parser = build_parser()
    ast = parser.parse("CLWB [RAX]", lexer=lexer)


3ï¸âƒ£ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ AST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”¹ Instruction
  Ø±ÛŒØ´Ù‡ Ø¯Ø±Ø®Øª Ù†Ø­ÙˆÛŒ

  Attributes:
    - mnemonic: str - Ù†Ø§Ù… Ø¯Ø³ØªÙˆØ±
    - operand: MemoryOperand | None
    - type: 'Instruction'

  Methods:
    - to_dict() -> dict
    - pretty_print(indent=0) -> list
    - get_instruction_category() -> str

  Ù…Ø«Ø§Ù„:
    inst = Instruction('CLFLUSH', memory_operand)
    print(inst.mnemonic)  # 'CLFLUSH'
    category = inst.get_instruction_category()  # 'flush'


ğŸ”¹ MemoryOperand
  Ø¢Ø¯Ø±Ø³ Ø­Ø§ÙØ¸Ù‡

  Attributes:
    - base: Register | Identifier
    - offset: str | None  (Ù…Ø«Ù„ "+16" ÛŒØ§ "-8")
    - type: 'MemoryOperand'

  Methods:
    - to_dict() -> dict
    - pretty_print(indent=0) -> list


ğŸ”¹ Register
  Ø±Ø¬ÛŒØ³ØªØ± CPU

  Attributes:
    - name: str (Ù…Ø«Ù„ 'EAX', 'RBX')
    - bit_width: int (32 ÛŒØ§ 64)
    - type: 'Register'

  Ù…Ø«Ø§Ù„:
    reg = Register('RAX')
    print(reg.bit_width)  # 64


ğŸ”¹ Identifier
  Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ Ù„ÛŒØ¨Ù„

  Attributes:
    - name: str
    - type: 'Identifier'


4ï¸âƒ£ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ Ù…Ø«Ø§Ù„ 1: Ù¾Ø§Ø±Ø³ Ø³Ø§Ø¯Ù‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from cache_parser import parse_instruction

code = "CLFLUSH [EAX]"
ast = parse_instruction(code)

if ast:
    print("âœ… Ù…ÙˆÙÙ‚!")
    print(f"Ø¯Ø³ØªÙˆØ±: {ast.mnemonic}")
    print(f"Ø¹Ù…Ù„ÙˆÙ†Ø¯: {ast.operand}")


ğŸ“Œ Ù…Ø«Ø§Ù„ 2: Ù†Ù…Ø§ÛŒØ´ Parse Tree
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ast = parse_instruction("CLFLUSHOPT [EBX+16]")

if ast:
    lines = ast.pretty_print()
    for line in lines:
        print(line)

# Ø®Ø±ÙˆØ¬ÛŒ:
# Instruction: CLFLUSHOPT
# â”œâ”€ Operand:
#   MemoryOperand:
#   â”œâ”€ Base: Register(EBX)
#   â””â”€ Offset: +16


ğŸ“Œ Ù…Ø«Ø§Ù„ 3: ØªØ­Ù„ÛŒÙ„ Ø¯Ø³ØªÙˆØ±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from cache_parser import parse_instruction, analyze_instruction

ast = parse_instruction("PREFETCHT0 [ECX-8]")
analysis = analyze_instruction(ast)

print(f"Ø¯Ø³ØªÙ‡: {analysis['category']}")
print(f"ØªÙˆØ¶ÛŒØ­: {analysis['description']}")
print(f"Ø±Ø¬ÛŒØ³ØªØ±: {analysis['operand']['base_value']}")
print(f"Offset: {analysis['operand']['offset_value']}")


ğŸ“Œ Ù…Ø«Ø§Ù„ 4: Ø®Ø±ÙˆØ¬ÛŒ JSON
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import json

ast = parse_instruction("CLWB [cache_line]")
json_output = ast.to_dict()

print(json.dumps(json_output, indent=2, ensure_ascii=False))

# Ø®Ø±ÙˆØ¬ÛŒ:
# {
#   "type": "Instruction",
#   "mnemonic": "CLWB",
#   "operand": {
#     "type": "MemoryOperand",
#     "base": {
#       "type": "Identifier",
#       "name": "cache_line"
#     },
#     "offset": null
#   }
# }


ğŸ“Œ Ù…Ø«Ø§Ù„ 5: Ù¾Ø§Ø±Ø³ ÙØ§ÛŒÙ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from cache_parser import parse_file

results, errors = parse_file("example2_with_offset.asm")

print(f"âœ“ Ù…ÙˆÙÙ‚: {len(results)} Ø¯Ø³ØªÙˆØ±")
print(f"âœ— Ø®Ø·Ø§: {len(errors)} Ø¯Ø³ØªÙˆØ±")

for line_num, code, ast in results:
    print(f"\nØ®Ø· {line_num}: {code}")
    category = ast.get_instruction_category()
    print(f"  Ø¯Ø³ØªÙ‡: {category}")


ğŸ“Œ Ù…Ø«Ø§Ù„ 6: Ø­Ø§Ù„Øª Debug
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ast = parse_instruction("CLFLUSH [EAX]", debug=True)

# Ø®Ø±ÙˆØ¬ÛŒ:
#   [REDUCE] CLFLUSH â†’ Mnemonic (Flush)
#   [REDUCE] EAX â†’ Register
#   [REDUCE] Register â†’ BaseExpr
#   [REDUCE] [ BaseExpr ] â†’ MemoryAddress
#   [REDUCE] MemoryAddress â†’ Operand
#   [REDUCE] Mnemonic + Operand â†’ Instruction


ğŸ“Œ Ù…Ø«Ø§Ù„ 7: Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ø±Ø¬ÛŒØ³ØªØ±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ast = parse_instruction("PREFETCHT0 [RAX]")

if ast.operand:
    base = ast.operand.base
    if isinstance(base, Register):
        if base.bit_width == 64:
            print("Ø±Ø¬ÛŒØ³ØªØ± 64-Ø¨ÛŒØªÛŒ")
        else:
            print("Ø±Ø¬ÛŒØ³ØªØ± 32-Ø¨ÛŒØªÛŒ")


5ï¸âƒ£ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”¸ Ø®Ø±ÙˆØ¬ÛŒ to_dict()
{
  "type": "Instruction",
  "mnemonic": "CLFLUSH",
  "operand": {
    "type": "MemoryOperand",
    "base": {
      "type": "Register",
      "name": "EAX",
      "bit_width": 32
    },
    "offset": null,
    "has_offset": false
  },
  "has_operand": true
}


ğŸ”¸ Ø®Ø±ÙˆØ¬ÛŒ analyze_instruction()
{
  'mnemonic': 'CLFLUSH',
  'category': 'flush',
  'description': 'Cache Flush - Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø®Ø· Ú©Ø´',
  'has_operand': True,
  'operand': {
    'base_type': 'Register',
    'base_value': 'EAX',
    'has_offset': False,
    'offset_value': None,
    'register_width': 32
  }
}


6ï¸âƒ£ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Parser Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ ØªØ´Ø®ÛŒØµ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯:

âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª:
   CLFLUSH EAX         # Ú©Ø±ÙˆØ´Ù‡ ÙØ±Ø§Ù…ÙˆØ´ Ø´Ø¯Ù‡
   â†’ Ø¨Ø§ÛŒØ¯: CLFLUSH [EAX]

âŒ Ø¹Ù…Ù„ÙˆÙ†Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±:
   CLFLUSH [+16]       # Ø±Ø¬ÛŒØ³ØªØ± Ù†ÛŒØ³Øª
   â†’ Ø¨Ø§ÛŒØ¯: CLFLUSH [EAX+16]

âŒ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù‚Øµ:
   CLFLUSH [EAX       # Ú©Ø±ÙˆØ´Ù‡ Ø¨Ø³ØªÙ‡ Ù†Ø´Ø¯Ù‡
   â†’ Ø¨Ø§ÛŒØ¯: CLFLUSH [EAX]

Ù…Ø«Ø§Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§:

try:
    ast = parse_instruction("INVALID CODE")
    if ast is None:
        print("Ø®Ø·Ø§ÛŒ Ù†Ø­ÙˆÛŒ Ø±Ø® Ø¯Ø§Ø¯")
except Exception as e:
    print(f"Ø®Ø·Ø§: {e}")


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
