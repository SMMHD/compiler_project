; ══════════════════════════════════════════════════════════════════
; نمونه دستورات کنترل حافظه نهان (Cache Control Instructions)
; ══════════════════════════════════════════════════════════════════
; تیم 15 - پروژه کامپایلر
; دانشگاه شهید باهنر کرمان
; زمستان ۱۴۰۴
; ══════════════════════════════════════════════════════════════════

; ────────────────────────────────────────────────────────────────
; بخش 1: دستورات Cache Flush (پاک‌سازی کش)
; ────────────────────────────────────────────────────────────────

CLFLUSH [EAX]           ; پاک‌سازی خط کش - رجیستر ساده
CLFLUSH [EBX+64]        ; پاک‌سازی با offset مثبت
CLFLUSH [ECX-16]        ; پاک‌سازی با offset منفی

CLFLUSHOPT [EDX]        ; پاک‌سازی بهینه‌شده
CLFLUSHOPT [ESI+128]    ; بهینه با offset بزرگ
CLFLUSHOPT [cache_data] ; با استفاده از label

; ────────────────────────────────────────────────────────────────
; بخش 2: دستورات Cache Prefetch (پیش‌خوانی)
; ────────────────────────────────────────────────────────────────

PREFETCHT0 [EDI]        ; پیش‌خوانی به L1 Cache
PREFETCHT0 [EBP+32]     ; پیش‌خوانی با Base Pointer

PREFETCHT1 [ESP]        ; پیش‌خوانی به L2 Cache
PREFETCHT1 [RAX+256]    ; رجیستر 64-bit

PREFETCHT2 [RBX]        ; پیش‌خوانی به L3 Cache
PREFETCHT2 [RCX-64]     ; با offset منفی

PREFETCHNTA [RDX+512]   ; پیش‌خوانی Non-Temporal
PREFETCHNTA [data_buffer] ; با label

; ────────────────────────────────────────────────────────────────
; بخش 3: دستورات Cache Write-Back (بازنویسی)
; ────────────────────────────────────────────────────────────────

CLWB [RSI]              ; بازنویسی خط کش
CLWB [RDI+1024]         ; با offset بزرگ
CLWB [temp_cache]       ; با label

; ────────────────────────────────────────────────────────────────
; بخش 4: دستورات Cache Invalidate (باطل‌سازی)
; ────────────────────────────────────────────────────────────────

WBINVD                  ; بازنویسی و باطل‌سازی کل کش
INVD                    ; باطل‌سازی فوری کل کش

; ────────────────────────────────────────────────────────────────
; بخش 5: رجیسترهای مدرن x64 (R8-R15)
; ────────────────────────────────────────────────────────────────

CLFLUSH [R8]            ; رجیستر مدرن 64-bit
CLFLUSH [R9+16]         ; با offset کوچک
CLFLUSHOPT [R10D]       ; نسخه 32-bit مدرن
PREFETCHT0 [R11+2048]   ; offset بزرگ
PREFETCHT1 [R12D-32]    ; 32-bit با offset منفی
PREFETCHNTA [R13]       ; پیش‌خوانی Non-Temporal
CLWB [R14+4096]         ; بازنویسی با offset خیلی بزرگ
CLFLUSH [R15D]          ; آخرین رجیستر مدرن

; ────────────────────────────────────────────────────────────────
; بخش 6: استفاده از Labels و Identifiers
; ────────────────────────────────────────────────────────────────

CLFLUSH [video_buffer]  ; بافر ویدئو
CLFLUSHOPT [network_rx] ; بافر دریافت شبکه
PREFETCHT0 [image_data] ; داده تصویر
PREFETCHNTA [audio_stream] ; جریان صوتی
CLWB [database_cache]   ; کش دیتابیس

; ────────────────────────────────────────────────────────────────
; بخش 7: ترکیبات پیشرفته
; ────────────────────────────────────────────────────────────────

CLFLUSH [RBP-8]         ; Stack Frame Access
CLFLUSHOPT [RSP+16]     ; Stack Pointer
PREFETCHT0 [RIP+100]    ; Instruction Pointer Relative
CLWB [array_base]       ; Base آرایه

; ────────────────────────────────────────────────────────────────
; بخش 8: سناریوهای واقعی
; ────────────────────────────────────────────────────────────────

; Scenario 1: پاک‌سازی بافر بعد از DMA
CLFLUSH [dma_buffer]
CLFLUSH [RDX+0]

; Scenario 2: بهینه‌سازی Loop
PREFETCHT0 [RSI+64]     ; پیش‌خوانی ایتم بعدی
PREFETCHT0 [RSI+128]    ; پیش‌خوانی دو ایتم جلوتر

; Scenario 3: همگام‌سازی Multi-Core
CLWB [shared_data]
WBINVD

; Scenario 4: بهینه‌سازی Real-Time
PREFETCHNTA [sensor_data] ; بدون آلودگی کش
CLFLUSHOPT [old_frame]    ; پاک‌سازی فریم قدیمی

; ══════════════════════════════════════════════════════════════════
; پایان فایل - جمع: 40+ دستور نمونه
; ══════════════════════════════════════════════════════════════════
